Mayaを使って日時処理をしてみよう
=================
## Arrow について
[Maya](https://github.com/kennethreitz/maya) は、Pyhton の DateTime オブジェ
クトの代わりに使用できる日時処理を扱うライブラリです。

 - Mayaのタイムゾーン処理は、システムロケールに関係なく、すべてのマシンで同じように動作します。
 - ISO 8601 と RFC 2822 の両方の日時スタンプを完全に対称的にインポート/エクスポートします。
 - 人に優しい表記の日付と機械用に書かれた日付の両方を問題なくパースします (maya.when() vs maya.parse()).
 - 人の時間表現のインポート/エクスポートを双方向にサポート(例:1時間前)
 - tzinfoの有無に関わらず、非常に簡単に日付時刻を生成することができます。
 - このライブラリはエポックタイムに基づいていますが、1970年1月1日以前の日付も負の整数でサポートされています。
日時処理で困ったことがあっても、Maya を使うとなんとか処理することができます。


Mayaのプロジェクトの目的は、人々がより簡単にデータ時刻を扱えるようにすることです。技術的には  Humanize、pytz、pendulumなど、Pythonで日付時刻を扱う人気のライブラリを組み合わせて統一的なAPIを提供したものです。

ここでは、Maya を使用して、他のコードでの処理例を再現する方法を説明します。

## インストール

## インストール
Maya は pip を使って、次のようにインストールします。

 bash
```
 # Linux or Mac
 $ python -m pip install maya

 # Windwos
 $ py -3 -m  pip install maya
```

## Mayaで日付を標準化する
まず、基本的な例から見ていきましょう。はじめに、maya をインポートする必要があります。次に、その parse メソッドを使用して日時れ文字列から MayaDT オブジェクトに変換します。 MayaDt はUnixと同様に内部的にはエポック時間で管理しています。

これに datetime メソッドを追加して、文字列から日時を取得することができます。


```
In [2]: # %load c01_maya_parse.py
   ...: import maya
   ...:
   ...: d1 = maya.parse('February 22 2022')
   ...: print(d1)
   ...:
   ...: d2 = maya.parse('February 22 2022').datetime()
   ...: print(d2)
   ...:
   ...: # d1
   ...: # d2
   ...:
Tue, 22 Feb 2022 00:00:00 GMT
2022-02-22 00:00:00+00:00

In [3]: d1
Out[3]: <MayaDT epoch=1645488000.0>

In [4]: d2
Out[4]: datetime.datetime(2022, 2, 22, 0, 0, tzinfo=<UTC>)

In [5]:
```

maya の `parser()` は強力で、人が記述する多くの日時文字列のパターンを
うまく処理してくれます。内部ではpendulumのパーサーを呼び出しています。
日本語の日時文字列はいまのところ例外が発生してしまいます。
これは、pendulumが日本語の日時文字列をうまく処理できないためです。


```
In [2]: # %load c02_maya_parse_humanized.py
   ...: import maya
   ...:
   ...: tests = [
   ...:     "22th of february 2022",
   ...:     "2/22/2022",
   ...:     "2-22-2022",
   ...:     "2 22 2022",
   ...:     "Feb 22 2022",
   ...:     "February 22 2022",
   ...:     "February 22st 2022",
   ...:     "22st of february 2022",
   ...:     "2022年2月22日",
   ...: ]
   ...:
   ...: for str_date in tests:
   ...:     try:
   ...:         d = maya.parse(str_date).datetime()
   ...:         print(d)
   ...:     except Exception as msg:
   ...:         print(f'Raise Exception: {msg}')
   ...:
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
2022-02-22 00:00:00+00:00
Raise Exception: Invalid date string: 2022年2月22日

In [3]:
```


## when()

`when()` メソッドに与えたタイムレーム文字列で MayaDT インスタンスを作成できます。


```
In [2]: # %load c03_when.py
   ...: import maya
   ...:
   ...: tests = [
   ...:     'last month',
   ...:     'Yesterday',
   ...:     'yesterday',
   ...:     'Tomorrow',
   ...:     'tomorrow',
   ...:     '昨日',
   ...:     '明日',
   ...:     '2日前',
   ...:     '2日後',
   ...:     '4週間後',
   ...:     '1ヶ月前',
   ...:     '1年後',
   ...:     ]
   ...:
   ...: for str_when in tests:
   ...:     d = maya.when(str_when)
   ...:     print(f'{str_when}: {d}')
   ...:
last month: 2022-06-13 05:29:05.799922+00:00
Yesterday: 2022-07-12 05:29:05.804412+00:00
yesterday: 2022-07-12 05:29:05.808327+00:00
Tomorrow: 2022-07-14 05:29:05.810613+00:00
tomorrow: 2022-07-14 05:29:05.812778+00:00
昨日: 2022-07-12 05:29:05.929835+00:00
明日: 2022-07-14 05:29:05.933505+00:00
2日前: 2022-07-11 05:29:05.936270+00:00
2日後: 2022-07-15 05:29:05.940617+00:00
4週間後: 2022-08-10 05:29:05.944614+00:00
1ヶ月前: 2022-06-13 05:29:05.948369+00:00
1年後: 2023-07-13 05:29:05.951073+00:00

In [3]:
```

この場合は、内部では dateparser が呼ばれているため、日本語を処理することができます。

## span()
`span()`メソッドを使うと、定義済みのオブジェクトの時間を調整することもできます。arrow などでは shift() と呼ばれるものです。
続いて、`snap()` メソッドを使用して、日、時間、秒などの単位で datetime を調整しています。
`rfc2822()` メソッドは、出力をフォーマットします。


```
In [2]: # %load c03_when.py
   ...: import maya
   ...:
   ...: dt = maya.when('May 24 2020 08:20:00 JST')
   ...:
   ...: d1 = dt.snap('@d+6h').rfc2822()
   ...: d2 = dt.snap('@d+5d+4h+3m+2s').rfc2822()
   ...:

In [3]: d1
Out[3]: 'Sat, 23 May 2020 06:00:00 GMT'

In [4]: d2
Out[4]: 'Thu, 28 May 2020 04:03:02 GMT'

In [5]:
```

## 参考

 - Maya
   - [Github/Maya](https://github.com/kennethreitz/maya)
